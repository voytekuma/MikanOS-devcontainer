## PCIデバイスの探索
- PCIとは部品とマザボをつなぐ規格
- PCI規格準拠の機器は256バイトのPCIコンフィギュレーション空間を持つ
    - ベンダID、クラスコードなどの基礎情報が含まれる
    - 読み書きするにはIOアドレス空間にあるCONFIG_ADDRESS, CONFIG_DATAレジスタを使う
        - CONFIG_ADDRESSに読み書きしたいPCIコンフィギュレーションの位置を指定
        - CONFIG_DATAを読み書きすることでPCIコンフィギュレーション空間を読み書きできる
- IOアドレス空間の読み書きには専用のIO命令が必要
    - C++では表現できないため、アセンブリで記述
- PCIバスは複数あり
    - 1つのPCIバスに最大32個のPCIデバイスが接続される
        - 1つのPCIデバイスは最大8つのファンクションを持つ
- バス0, デバイス0は必ずホストブリッジ
    - CPUとPCIデバイス間の通信が通過する
- ヘッダタイプ(8bit)によってPCIコンフィギュレーション空間の16バイト以降の構造が異なる
    - ヘッダタイプの最上位ビットが1の場合はマルチファンクションデバイス
        - ホストブリッジが複数存在し、ファンクション番号が担当バス番号を表す
- 各デバイスの存在を調べるには、ファンクション0のベンダIDを0xffffと比較する
- 各ファンクションの存在を調べるには、各ファンクションのベンダIDを0xffffと比較する
- クラスコード(32bit)にはベースクラス(8bit)、サブクラス(8bit)が含まれる
    - ベースクラス0x06, サブクラス0x04のファンクションはPCI-to-PCIブリッジ
        - 2つのPCIバス同士をつなぐ

<br>

## ポーリングでマウス入力
- xHCを検索
    - ベースクラス0x0cはシリアルバスコントローラ
    - サブクラス0x03はUSBコントローラ
    - インターフェース0x30はxHCI
- MMIO
    - メモリアドレス空間にあるレジスタ
    - メモリアドレスが付与されているのでアドレスでアクセスできる
    - PCIコンフィギュレーション空間のBase Address Register0にMMIOのアドレスが記録されている

<br>

## day10へ続く...


